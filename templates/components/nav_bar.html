
{% load static %}
{% load custom_tags %}

<!-- This is the navagation bar section, which contains the navigation elements. -->
<div id="nav_bar" class="flex items-center gap-4 h-8 my-3">
    <img src="/static/images/logo.png" alt="Logo" class="object-contain h-10 w-28">
    <!-- This is the left part of the navagation bar with the logo, buttons -->
    <div id="nav_bar_left" class="flex items-center gap-1 flex-grow">
    
        

            <div id="nav_menu" class="flex items-center gap-1">
                    <!-- Main navigation items based on nav_items -->
                {% for page_key, page_info in nav_items.items %}
                    <div class="relative group">
                        <div class="p-2 flex justify-start items-center rounded-xl hover:bg-gray-200 dark:hover:bg-gray-800 text-nowrap cursor-pointer text-theme {% if request.resolver_match.url_name == page_key %}bg-gray-200 dark:bg-gray-800{% endif %} nav-item" data-page="{{ page_key }}">
                            {% if page_key == 'page_home' %}
                                <span class="fa fa-home w-8" style="font-size: 18px;"></span>
                            {% elif page_key == 'page_projects' %}
                                <span class="fa fa-building w-8" style="font-size: 18px;"></span>
                            {% elif page_key == 'page_general_data' %}
                                <span class="fa fa-database w-8" style="font-size: 18px;"></span>
                            {% elif page_key == 'page_transport_department' %}
                                <span class="fa fa-truck w-8" style="font-size: 18px;"></span>
                            {% endif %}
                            <span>{{ page_info.page_name }}</span>
                            {% if page_info.sub_pages %}
                                <span class="fa fa-chevron-down ml-1 text-xs transition-transform duration-75 group-hover:rotate-180"></span>
                            {% endif %}
                        </div>
                        
                        {% if page_info.sub_pages %}
                            <!-- Dropdown menu for sub-pages -->
                            <div class="absolute left-0 mt-1 w-80 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-100 z-50">
                                <div class="p-2 grid grid-cols-1 gap-1">
                                    {% for sub_page_key, display_name in page_info.sub_pages.items %}
                                        <a up-preload="insert" href="{% url page_key sub_page=sub_page_key %}" 
                                           class="p-2 text-theme hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg flex items-start nav-sub-item {% if sub_page == sub_page_key %}bg-gray-100 dark:bg-gray-700{% endif %}"
                                           data-page="{{ page_key }}" data-sub-page="{{ sub_page_key }}">
                                            <span class="fa fa-circle text-xs mr-3 mt-1"></span>
                                            {{ display_name }}
                                        </a>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            
            <!-- Vertical separator and current table badge -->
            {% if page_name %}
            <div class="h-8 w-px bg-gray-300 dark:bg-gray-700 mx-1 me-3"></div>
            <div id="current-content" class="flex items-center flex-grow">
                <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-cyan-100 dark:bg-cyan-900 text-cyan-800 dark:text-cyan-100 text-md font-medium border border-cyan-300 dark:border-cyan-800">
                    <i class="fa fa-table" aria-hidden="true"></i>
                    <span class="text-nowrap"> Đang xem: </span>
                    <span class="page-name text-ellipsis overflow-hidden whitespace-nowrap" style="text-overflow: ellipsis; display: inline-block; max-width: 400px">{{ page_name }}</span>
                </div>
            </div>
            {% endif %}
    </div>

    <!-- This is the right part of the navagation bar with quick settings, and profile dropdown. -->
    <div id="nav_bar_right" class="flex items-center gap-5">

        <!-- Display user role with an icon and styled text -->
        <div id="user_role" class="flex justify-center items-center gap-2 px-3 py-1 rounded-full bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-100 text-md font-semibold text-nowrap">
            <i class="fa fa-user-circle" aria-hidden="true"></i> <!-- Add user icon -->
            {% if user.first_name %}
                <span>{{ user.first_name }}</span> <!-- Display the user role (human-readable) -->
            {% else %}
                <span>{{ user }}</span> <!-- Display the user role (human-readable) -->
            {% endif %}
        </div>


        <!-- This div contains quick settings that can be toggled. -->
        <div id="quick-settings" class="flex justify-between gap-4">

            <!-- Toggle for light and dark theme. -->
            <label class="text-theme transition-all duration-300 ease-in-out cursor-pointer">
                <!-- this hidden checkbox controls the state -->
                <input id="theme-toggle" class="hidden" type="checkbox">
                        
                <div class="relative w-7 h-7">
                    <!-- sun icon -->
                    <svg id="sun-icon" class="absolute inset-0 fill-current transition-opacity duration-300 ease-in-out" style="opacity: 1;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z" />
                    </svg>
                    <!-- moon icon -->
                    <svg id="moon-icon" class="absolute inset-0 fill-current transition-opacity duration-300 ease-in-out" style="opacity: 0;"  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z" />
                    </svg>
                </div> 
            </label>

        </div>

        <!-- Profile Picture and Dropdown  -->
        <div id="profile" class="menu relative">
            <!-- Profile picture dropdown button. -->
            <div class="menu-button cursor-pointer">
                <div class="flex justify-center items-center w-10 h-10 border-2 border-cyan-700 rounded-full shadow-xl">
                    <img src="https://hastingsmotor.com/hmc/wp-content/uploads/2022/08/shutterstock_1517146850-1-1.png" alt="Profile Picture" class="rounded-full object-cover w-11 h-9">
                </div>
            </div>
            <!-- Dropdown Menu -->
            <ul id="menu-profile" class="dropdown-menu absolute hidden right-0 p-2">

                <a href="#" class="menu-item rounded-t-xl rounded-b-xl m-1">
                    <i class="fa fa-user ml-3 mr-6"></i>
                    <span>Thông tin tài khoản</span>
                </a>
                <a href="#" class="menu-item rounded-t-xl rounded-b-xl m-1">
                    <i class="fa fa-gear ml-3 mr-5"></i>
                    <span>Cài đặt</span>
                </a>

                <a href="{% url 'logout' %}" class="menu-item rounded-t-xl rounded-b-xl m-1">
                    <i class="fa fa-sign-out ml-3 mr-5"></i>
                    <span>Thoát</span>
                </a>

            </ul>
        </div>
    </div>
</div>
<!-- Horizontal line to separate the navagation bar from the rest of the content. -->
<hr class="border-t border-gray-300 dark:border-gray-800 mt-3 mb-3" />

<!-- JavaScript for navigation highlighting -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get all navigation items
        const navItems = document.querySelectorAll('.nav-item');
        const navSubItems = document.querySelectorAll('.nav-sub-item');
        
        // Function to handle navigation item click
        function handleNavItemClick(e) {
            // Remove active class from all nav items
            navItems.forEach(item => {
                item.classList.remove('bg-gray-200', 'dark:bg-gray-800');
            });
            
            // Add active class to clicked item
            this.classList.add('bg-gray-200', 'dark:bg-gray-800');
        }
        
        // Function to handle sub-navigation item click
        function handleNavSubItemClick(e) {
            // Remove active class from all sub nav items
            navSubItems.forEach(item => {
                item.classList.remove('bg-gray-100', 'dark:bg-gray-700');
            });
            
            // Add active class to clicked sub item
            this.classList.add('bg-gray-100', 'dark:bg-gray-700');
            
            // Also highlight parent menu
            const parentPage = this.getAttribute('data-page');
            const parentNavItem = document.querySelector(`.nav-item[data-page="${parentPage}"]`);
            if (parentNavItem) {
                navItems.forEach(item => {
                    item.classList.remove('bg-gray-200', 'dark:bg-gray-800');
                });
                parentNavItem.classList.add('bg-gray-200', 'dark:bg-gray-800');
            }
        }
        
        // Add click event listeners
        navItems.forEach(item => {
            item.addEventListener('click', handleNavItemClick);
        });
        
        navSubItems.forEach(item => {
            item.addEventListener('click', handleNavSubItemClick);
        });
        
        // Store current page and sub-page in localStorage when navigating
        document.querySelectorAll('.nav-item, .nav-sub-item').forEach(item => {
            item.addEventListener('click', function() {
                const page = this.getAttribute('data-page');
                const subPage = this.getAttribute('data-sub-page') || '';
                
                localStorage.setItem('currentPage', page);
                localStorage.setItem('currentSubPage', subPage);
            });
        });
        
        // Check if we should restore highlighting from localStorage
        const storedPage = localStorage.getItem('currentPage');
        const storedSubPage = localStorage.getItem('currentSubPage');
        
        if (storedPage && !document.querySelector('.nav-item.bg-gray-200, .nav-item.dark\\:bg-gray-800')) {
            const navItem = document.querySelector(`.nav-item[data-page="${storedPage}"]`);
            if (navItem) {
                navItem.classList.add('bg-gray-200', 'dark:bg-gray-800');
            }
            
            if (storedSubPage) {
                const subItem = document.querySelector(`.nav-sub-item[data-page="${storedPage}"][data-sub-page="${storedSubPage}"]`);
                if (subItem) {
                    subItem.classList.add('bg-gray-100', 'dark:bg-gray-700');
                }
            }
        }
    });
</script>
