{% load custom_tags %}
<div up-hungry id="modal-sub">
    <div id="modal-sub-body" class="modal z-40 fixed inset-0 h-screen w-full flex justify-center overflow-auto bg-slate-600 bg-opacity-60">
        <!-- Modal Content -->
        <div class="relative top-10 mx-4 card h-12/12 w-11/12 mb-28">
                <h3 class="mt-4 mb-4 text-xl font-bold leading-6 text-center text-theme">Danh sách vật tư - Giám sát đặt</h3>

                <button id='cancel-modal' type="button" class="cancel-modal absolute top-5 right-4 btn btn-secondary rounded-full text-nowrap h-6 w-6 text-sm" onclick="document.getElementById('modal-sub-body').remove();">
                    <i class="fa fa-times" aria-hidden="true"></i>
                </button>

                <div class="flex justify-center mb-4 mx-4 gap-5">

                    <div id="search-bar" class="h-10 flex w-[300px]">
                        <!-- Input field for filter values -->
                        <input id="filter-input" type="text" placeholder="Nhập để tìm kiếm ..." class="form-input rounded-lg h-full border-theme dark:border-gray-600 border-opacity-30 text-theme" autocomplete="off">
                    </div>

                    <button id="all-supplies" type="button" class="btn btn-outline border-theme dark:border-gray-600 border-opacity-30 text-theme">Tất cả vật tư</button>
                    <button id="selected-supplies" type="button" class="btn btn-outline border-theme dark:border-gray-600 border-opacity-30 text-theme">Vật tư đã chọn</button>
                    <button id="unselected-supplies" type="button" class="btn btn-outline border-theme dark:border-gray-600 border-opacity-30 text-theme">Vật tư chưa chọn</button>
                </div>

            
                <div class="h-full">
                    {% csrf_token %}
                    <div class="flex flex-col h-full justify-between gap-5 text-sm text-theme">
                        <p id="no-supplies" class="hidden text-center mt-14 text-xl">Không tìm thấy vật tư trong danh sách, vui lòng tìm kiếm với từ khóa khác.</p>
                        <div id="repair-part-cards" class="flex flex-wrap justify-center gap-6 px-6 h-fit overflow-y-scroll">
                            {% for supply in supplies %}
                            <div class="relative card-supply provider-{{ supply.supply_provider.id }} card-supply-{{ supply.id }} bg-gray-50 dark:bg-gray-700 border border-slate-300 dark:border-slate-900 border-opacity-50 rounded-2xl" style="width: 15rem;" >

                                <div class="input-supply absolute top-28 w-full hidden flex flex-row justify-center">
                                    <div class="bg-white dark:bg-gray-700 border border-slate-300 dark:border-slate-900 border-opacity-50 rounded-2xl px-2 py-1 text-sm w-5/6 flex flex-row justify-center items-center">
                                        <label class="mr-2">SL ({{  supply.unit }})</label>
                                        <input type="hidden" name="supply_id" value="{{ supply.id }}">
                                        <input type="hidden" name="supply_number" value="{{ supply.supply_number }}">
                                        <input type="hidden" name="supply_name" value="{{ supply.supply_name }}">
                                        <input type="number" name="supply_quantity" value="1" class="form-input no-readable bg-transparent outline-none" style="width: 100px; height: 30px;">
                                    </div>
                                </div>

                                <div style="height: 10rem;">
                                    {% if supply.image %}
                                    <img src="{{ supply.image.url }}" alt="{{ supply.supply_name }}"
                                        class="rounded-t-2xl border-b border-slate-300 dark:border-slate-900 border-opacity-50 h-full w-full object-cover" />
                                    {% else %}
                                    <img src="/static/images/default/default_part.webp" alt="Default Supply Image"
                                        class="rounded-t-2xl border-b border-slate-300 dark:border-slate-900 border-opacity-50 h-full w-full object-cover" />
                                    {% endif %}
                                </div>

                                <div class="flex justify-between items-center px-2 relative">
                                    <div class="w-10/12">
                                        <h3 class=" font-semibold text-theme text-center pl-1">
                                            {{ supply.supply_number }} - {{ supply.supply_name }}
                                        </h3>
                                    </div>
                                </div>
                    
                                <div class="flex flex-col text-sm px-2 pb-3 ">
                                    <!-- Keep <p> for paragraphs of text -->
                                    <div class="mt-1.5 note whitespace-pre-line">Mô tả: {{ supply.note }} </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="flex flex-col justify-center gap-5">
                            <div class="flex justify-center gap-5">
                                <button type="submit" id="submit-slections" class="submit btn btn-primary rounded-full w-28">
                                    Cập nhật
                                </button>
                                <button id='cancel-modal' type="button" class="cancel-modal btn btn-secondary rounded-full w-28" onclick="document.getElementById('modal-sub-body').remove();">
                                    Hủy bỏ
                                </button>
                            </div>
                            <div class="h-28"></div>
                        </div>
                    </div>
                </div>
        </div>
    </div>
    <script>
        function showNoItems() {
            // If card-supply = car-part hidden => show "no-supplies" else hidden
            if (document.querySelectorAll('.card-supply:not(.hidden)').length == 0) {
                document.getElementById('no-supplies').classList.remove('hidden');
            } else {
                document.getElementById('no-supplies').classList.add('hidden');
            }
        }


        // Hide modal
        document.getElementById('modal').classList.add('hidden');
        document.querySelectorAll('.cancel-modal').forEach(el => {
            el.addEventListener('click', function(){
                document.getElementById('modal').classList.remove('hidden');
            })
        })

        
        // Click card-supply add class "selected" and input-supply show
        document.querySelectorAll('.card-supply').forEach(el => {
            el.addEventListener('click', function(){
                this.classList.toggle('selected');
                this.querySelector('.input-supply').classList.toggle('hidden');
                this.querySelector('.input-supply').addEventListener('click', function(e){
                    e.stopPropagation();
                })
            })
        })

        // Filter
        document.getElementById('filter-input').addEventListener('keyup', function(){
            const value = document.getElementById('filter-input').value.toLowerCase().trim();
            document.querySelectorAll('.card-supply').forEach(el => {
                const text = el.textContent.toLowerCase().trim();
                if (text.includes(value)) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            })
            showNoItems();
        })
        // Filter button all parts
        document.getElementById('all-supplies').addEventListener('click', function(){
            document.querySelectorAll('.card-supply').forEach(el => {
                    el.classList.remove('hidden');
                    document.getElementById('filter-input').value = '';
                    showNoItems();
            })
        })
        // Filter button selected parts
        document.getElementById('selected-supplies').addEventListener('click', function(){
            document.querySelectorAll('.card-supply').forEach(el => {
                if (el.classList.contains('selected')) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
                document.getElementById('filter-input').value = '';
                showNoItems();
            })
        })
        // Filter button unselected parts
        document.getElementById('unselected-supplies').addEventListener('click', function(){
            document.querySelectorAll('.card-supply').forEach(el => {
                if (!el.classList.contains('selected')) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
                document.getElementById('filter-input').value = '';
                showNoItems();
            })
        })

        // Select cards from data from maintanance
        document.querySelectorAll('.order-supply').forEach(el => {
            console.log(el);
            const supplyId = el.getAttribute('data-supply-id');
            const supplyQuantity = el.getAttribute('data-supply-quantity');
            const cardsupply = document.querySelector(`.card-supply-${supplyId}`);
            if (cardsupply && supplyQuantity > 0) {
                cardsupply.classList.add('selected');
                cardsupply.querySelector('.input-supply').classList.remove('hidden');
                cardsupply.querySelectorAll('input[name="supply_quantity"]').forEach(el => {
                    el.disabled = false;
                    el.value = supplyQuantity;
                })
            }
        })

        // Submit form
        document.getElementById('submit-slections').addEventListener('click', function(){
            let orderSupplies = [];
            document.querySelectorAll('.card-supply.selected').forEach(el => {
                const supplyId = el.querySelector('input[name="supply_id"]').value;
                const supplyNumber = el.querySelector('input[name="supply_number"]').value;
                const supplyName = el.querySelector('input[name="supply_name"]').value;
                // Make partPrice human readable
                const supplyQuantity = el.querySelector('input[name="supply_quantity"]').value;

                orderSupplies.push(`
                    <div class="order-supply border-b py-2 flex items-center w-full" data-supply-id="${supplyId}" data-supply-quantity="${supplyQuantity}">
                        <input type="hidden" name="supply_id" value="${supplyId}">
                        <input type="hidden" name="supply_quantity_${supplyId}" value="${supplyQuantity}">
                        <span class="w-6/12">${supplyNumber} - ${supplyName} </span>
                        <span class="w-1/12 text-center">${supplyQuantity}</span>
                        <div class="w-2/12 flex justify-center"></div>
                        <div class="w-1/12 flex justify-center"></div>
                        <div class="w-2/12 flex justify-center"></div>
                    </div>
                `);
            });

            document.getElementById('order-supplies').innerHTML = orderSupplies.join('');
            // Click cancel model to close this modal
            document.querySelector('.cancel-modal').click();
        })
    </script>
</div>


