{% load custom_tags %}
<div up-hungry id="modal">
    <div id="modal-body" class="modal z-40 fixed inset-0 bg-slate-600 bg-opacity-60 h-full w-full flex justify-center overflow-auto">
        <!-- Modal Content -->
        <div class="relative top-16 mx-4 card h-fit w-full sm:w-fit mb-28  pb-8">
            <h3 class="mt-7 mb-6 text-xl font-bold leading-6 text-center text-theme">{{ title }}</h3>

            <button id='cancel-modal' type="button" class="absolute top-5 right-4 btn btn-secondary rounded-full text-nowrap h-6 w-6 text-sm" onclick="document.getElementById('modal-body').remove();">
                <i class="fa fa-times" aria-hidden="true"></i>
            </button>

    
            {% if modal == "modal_VehicleMaintenance" or modal == "modal_SupplyOrder" %}
                {% if record %}
                    <button id="btn-edit" class="absolute top-5 left-4 btn btn-primary rounded-full text-nowrap h-8 w-28 text-sm"
                            onclick="toggleModalEdit(this)">
                        <i class="fas fa-eye me-3" style="font-size: 16px;"></i>
                        Ch·ªâ xem
                    </button>
                    <button id="btn-view" class="absolute top-5 left-4 btn btn-primary rounded-full text-nowrap h-8 w-28 text-sm hidden"
                            onclick="toggleModalEdit(this)">
                        <i class="fas fa-pencil me-3" style="font-size: 16px;"></i>
                        Ch·ªânh s·ª≠a
                    </button>   
                    <a href="{% url 'form_maintenance_images' record.pk %}" class="absolute top-5 left-36 btn btn-primary rounded-full text-nowrap h-8 w-28 text-sm"
                        up-preload="insert" up-target="#modal-sub:maybe">
                        Xem h√¨nh ·∫£nh
                    </a>
                    
                {% else %}
                    <script>
                        function toggleModalEdit() {
                            console.log("Hellosakhdfsdkfasjkl");
                            const modal = document.getElementById('modal');
                            modal.querySelectorAll('.hidable').forEach(el => el.classList.remove('hidden'));
                            modal.querySelectorAll('.auto-field').forEach(el => el.disabled = false);
                        }
                        toggleModalEdit();
                    </script>
                {% endif %}


                
                {% if record.approval_status == "scratch" or record.approval_status == "need_update" %}
                    <script>
                    function toggleModalEdit(button) {
                        const modal = button.closest('.modal');
                        const hideables = modal.querySelectorAll('.hidable');
                        const autoFields = modal.querySelectorAll('.auto-field');
                        const approveHideables = modal.querySelectorAll('.approve-hidable');
                        hideables.forEach(el => el.classList.toggle('hidden'));
                        autoFields.forEach(el => el.disabled = !el.disabled);
                        document.getElementById('btn-view').classList.toggle('hidden');
                        document.getElementById('btn-edit').classList.toggle('hidden');
                    }
                    </script>
                {% elif record.approval_status == "wait_for_approval" %}
                    {% if permissions.approve %}
                    <script>
                        function toggleModalEdit(button) {
                            const modal = button.closest('.modal');
                            const hideables = modal.querySelectorAll('.hidable');
                            const autoFields = modal.querySelectorAll('.auto-field');
                            const approveHideables = modal.querySelectorAll('.approve-hidable');
                            hideables.forEach(el => el.classList.toggle('hidden'));
                            autoFields.forEach(el => el.disabled = !el.disabled);
                            document.getElementById('btn-view').classList.toggle('hidden');
                            document.getElementById('btn-edit').classList.toggle('hidden');
                        }
                    </script>
                    {% else %}
                    <script>
                        function toggleModalEdit(button) {
                            alert("Kh√¥ng th·ªÉ ch·ªânh s·ª≠a khi ƒëang ch·ªù ph√™ duy·ªát")
                        }
                    </script>
                    {% endif %}

                {% elif record.approval_status == "approved" %}
                    {% if permissions.approve %}
                    <script>
                        function toggleModalEdit(button) {
                            const modal = button.closest('.modal');
                            const approveHideables = modal.querySelectorAll('.approve-hidable');
                            approveHideables.forEach(el => el.classList.toggle('hidden'));
                            document.getElementById('btn-view').classList.toggle('hidden');
                            document.getElementById('btn-edit').classList.toggle('hidden');
                        }
                    </script>
                    {% else %}
                    <script>
                        function toggleModalEdit(button) {
                            const modal = button.closest('.modal');
                            const approveHideables = modal.querySelectorAll('.approve-hidable');
                            approveHideables.forEach(el => el.classList.toggle('hidden'));
                            document.getElementById('btn-view').classList.toggle('hidden');
                            document.getElementById('btn-edit').classList.toggle('hidden');
                        }
                    </script>
                    {% endif %}
                {% elif record.approval_status == "rejected" %}
                    {% if permissions.approve %}
                    <script>
                        function toggleModalEdit(button) {
                            const modal = button.closest('.modal');
                            const approveHideables = modal.querySelectorAll('.approve-hidable');
                            approveHideables.forEach(el => el.classList.toggle('hidden'));
                            document.getElementById('btn-view').classList.toggle('hidden');
                            document.getElementById('btn-edit').classList.toggle('hidden');
                        }
                    </script>
                    {% else %}
                    <script>
                        function toggleModalEdit(button) {
                            alert("Kh√¥ng th·ªÉ ch·ªânh s·ª≠a khi phi·∫øu b·ªã t·ª´ ch·ªëi ph√™ duy·ªát.")
                        }
                    </script>
                    {% endif %}
                {% endif %}
                
            {% endif %}
            <!-- Result could be a html card if success or a new form modal with error if fail, if success, the card will be added right after the div cards, else the form will be the same place but display as fixed -->
            <form enctype="multipart/form-data" method="post"
                   action="{{ form_url }}" up-submit
                    {% if record %}
                        up-target="#modal:maybe, #record_{{ record.pk }}:maybe"
                    {% else %}
                        up-target="#modal:maybe, #display-table-records:before:maybe, #display-records:before:maybe"
                    {% endif %}>

                {% if form.non_field_errors %}
                <div class="px-6 py-3">
                    {% for error in form.non_field_errors %}
                        <p class="text-red-500 whitespace-pre-line">{{ error }}</p>
                    {% endfor %}
                </div>  
                {% endif %}

                {% if form.fields|length >= 13 or modal == 'modal_VehicleMaintenance'  or modal == 'modal_SupplyOrder' %}
                <div class="grid grid-cols-1 sm:grid-cols-3 sm:w-[1100px] gap-4 px-6">
                
                {% elif form.fields|length >= 6 and form.fields|length < 13 %}
                <div class="grid grid-cols-1 sm:grid-cols-2 sm:w-[700px] gap-4 px-6">

                {% else %}
                <div class="grid grid-cols-1 w-[500px]  gap-4 px-6">
                {% endif %}

                    {% if project_id and model != 'ProjectUser'  %}  
                        <input type="hidden" name="project" value="{{ project_id }}">
                    {% endif %}

                    {% if model != 'UserPermission' and form.user.name == 'user' %} 
                        {% if record.user %}
                            <input type="hidden" name="user" value="{{ record.user.id }}">
                        {% else %}
                            <input type="hidden" name="user" value="{{ user.id }}">
                        {% endif %}
                    {% endif %}

                    {% csrf_token %}
                    {% for field in form %}
                        {% if model == 'UserPermission' and field.name == 'user'  or  field.name != 'user' and field.name != 'approval_status' and field.name != 'project' and field.name != 'description' and field.name != 'note' %}
                        <div class="">
                                <div>
                                    <label for="{{ field.name }}" class="text-theme">{{ field.label }}</label>
                                    {{ field }}    
                                
                                    {% if field.help_text %}
                                        <p class="text-blue-500 px-3">{{ field.help_text }}</p>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <p class="text-red-500 px-3">{{ error }}</p>
                                    {% endfor %}
                                </div>
                        </div>
                        {% endif %}
                    {% endfor %}

                    {% if form.description.name == 'description' %}  
                    <div class="col-span-full">
                            <label for="description" class="text-theme">M√¥ t·∫£</label>
                            {{ form.description }}    
                    </div>
                    {% endif %}

                    {% if form.note.name == 'note' %}  
                    <div class="col-span-full">
                            <label for="note" class="text-theme">Ghi ch√∫</label>
                            {{ form.note }}    
                    </div>
                    {% endif %}

                    {% if record.provider %}  
                    <div class="col-span-full flex items-center w-full flex-col justify-center bg-white dark:bg-gray-800 shadow-lg rounded-lg p-4 border border-blue-300 dark:border-blue-500">
                        <span class="text-lg font-bold text-green-600  uppercase tracking-wide">
                            üîπ Th√¥ng tin thanh to√°n üîπ
                        </span>
                        <div>
                            <span class="text-xl text-gray-900 dark:text-gray-100 font-semibold mt-2">
                                {{ record.provider.bank_name }} - 
                            </span>
                            <span class="text-xl text-blue-500 dark:text-blue-400 font-semibold">
                                {{ record.provider.account_holder_name }} - 
                            </span>
                            <span class="text-xl text-red-500 dark:text-red-400 font-semibold">
                                {{ record.provider.account_number }}
                            </span>
                        </div>
                    </div>
                    
                    {% endif %}
                </div>

                {% if modal == "modal_VehicleMaintenance" %}
            
                    <div class="w-full pt-4 px-6 pt-5- pb-2">
                        <div class="flex flex-row gap-5 items-end py-2">
                            <label for="students" class="text-theme">Tr·∫°ng th√°i phi·∫øu s·ª≠a ch·ªØa</label>
                        </div>
                        <div class="form-input flex flex-col h-fit h-max-[300px] overflow-y-scroll">
                            <div class="flex justify-between w-full font-semibold">
                                <span class="w-3/12 text-center"> Tr·∫°ng th√°i duy·ªát </span>
                                <span class="w-3/12 text-center"> Tr·∫°ng th√°i nh·∫≠n h√†ng </span>
                                <span class="w-3/12 text-center"> Tr·∫°ng th√°i thanh to√°n </span>
                                <span class="w-3/12 text-center"> Tr·∫°ng th√°i s·ª≠a ch·ªØa </span>
                            </div> 
                            <div class="pt-3 pb-1 flex justify-between items-center w-full">
                                <div class="w-3/12 flex justify-center">
                                    {% if record %}
                                        <span class="{{ record|get_value:'approval_status' }} text-white p-1 rounded-md shadow-2xl px-2 text-nowrap hidable approve-hidable">{{ record|format_display:'approval_status' }}</span>
                            
                                        {% if not permissions.approve %}
                                        <select name="approval_status" class="form-input hidable approve-hidable hidden" id="id_approval_status" style="width: 150px">
                                            {% if record.approval_status == "scratch" %}
                                                <option selected value="scratch">B·∫£ng nh√°p</option>
                                                <option value="wait_for_approval">ChoÃõÃÄ duy·ªát</option>
                                                
                                            {% elif record.approval_status == "wait_for_approval" %}
                                                <option selected value="wait_for_approval">ChoÃõÃÄ duy·ªát</option>
                                                
                                            {% elif record.approval_status == "approved" %}
                                                <option selected value="approved">ƒêaÃÉ duyeÃ£ÃÇt</option>

                                            {% elif record.approval_status == "need_update" %}
                                                <option value="wait_for_approval">ChoÃõÃÄ duy·ªát</option>
                                                <option selected value="need_update">C·∫ßn s·ª≠a l·∫°i</option>

                                            {% elif record.approval_status == "rejected" %}
                                                <option value="rejected">TuÃõÃÄ choÃÇÃÅi</option>
                                            {% endif %}
                                        </select>
                                        {% else %}
                                        <select name="approval_status" class="form-input hidable approve-hidable hidden" id="id_approval_status" style="width: 150px">
                                            {% if record.approval_status == "scratch" %}
                                                <option selected value="scratch">B·∫£ng nh√°p</option>
                                                <option value="wait_for_approval">ChoÃõÃÄ duy·ªát</option>

                                            {% elif record.approval_status == "wait_for_approval" %}
                                                <option selected value="wait_for_approval">ChoÃõÃÄ duy·ªát</option>
                                                <option value="approved">ƒêaÃÉ duyeÃ£ÃÇt</option>
                                                <option value="need_update">C·∫ßn s·ª≠a l·∫°i</option>
                                                <option value="rejected">TuÃõÃÄ choÃÇÃÅi</option>

                                            {% elif record.approval_status == "approved" %}
                                                <option selected value="approved">ƒêaÃÉ duyeÃ£ÃÇt</option>
                                                <option value="need_update">C·∫ßn s·ª≠a l·∫°i</option>

                                            {% elif record.approval_status == "need_update" %}
                                                <option value="wait_for_approval">ChoÃõÃÄ duy·ªát</option>
                                                <option selected value="need_update">C·∫ßn s·ª≠a l·∫°i</option>

                                            {% elif record.approval_status == "rejected" %}
                                                <option value="need_update">C·∫ßn s·ª≠a l·∫°i</option>
                                                <option selected value="rejected">TuÃõÃÄ choÃÇÃÅi</option>
                                            {% endif %}
                                        
                                        </select>
                                        {% endif %}
                                        {% else %}
                                            <select name="approval_status" class="form-input hidable approve-hidable hidden" id="id_approval_status" style="width: 150px">
                                                
                                                <option selected value="scratch">B·∫£ng nh√°p</option>
                                            </select>
                                                <span class="scratch text-white p-1 rounded-md shadow-2xl px-2 text-nowrap hidable approve-hidable">B·∫£n nh√°p</span>
                                        {% endif %}
                                </div>
                                {% if record %}
                                <div class="w-3/12 text-center">
                                    <span class="{{ record|get_value:'received_status' }} text-white p-1 rounded-md shadow-2xl px-2 text-nowrap">{{ record|format_display:'received_status' }}</span>
                                </div>
                                <div class="w-3/12 text-center">
                                    <span class="{{ record|get_value:'paid_status' }} text-white p-1 rounded-md shadow-2xl px-2 text-nowrap">{{ record|format_display:'paid_status' }}</span>
                                </div>
                                <div class="w-3/12 text-center">
                                    <span class="{{ record|get_value:'done_status' }} text-white p-1 rounded-md shadow-2xl px-2 text-nowrap">{{ record|format_display:'done_status' }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>


                    <div class="w-full pt-4 px-6">
                        <p class="text-center text-theme"> L∆∞u √Ω: c√°c s·ªë li·ªáu t√†i ch√≠nh ch·ªâ ƒë∆∞·ª£c t√≠nh to√°n sau khi b·∫•m c·∫≠p nh·∫≠t </p>
                        <div class="flex flex-row justify-between gap-5 items-center py-1">
                            <div class="flex flex-row gap-5 items-end py-2">
                                <label for="students" class="text-theme">C√°c b·ªô ph·∫≠n thay th·∫ø</label>
                                <!-- <button class="btn btn-success h-7 hidable hidden" onclick="event.preventDefault(); var newPart = document.querySelector('.new-part').cloneNode(true); newPart.classList.remove('hidden'); newPart.classList.remove('new-part'); newPart.querySelectorAll('input').forEach(input => input.value = ''); document.querySelector('.new-part').parentNode.insertBefore(newPart, document.querySelector('.new-part').nextSibling);">
                                    <i class="fas fa-plus me-3" style="font-size: 16px;"></i>
                                    Th√™m v√†o danh m·ª•c
                                </button> -->

                                <a href="{% url 'form_repair_parts' %}?maintenance={{ record.pk }}" class="btn btn-success h-7 hidable hidden"
                                    up-preload="insert" up-target="#modal-sub:maybe">
                                    <span class="me-3"> Ch·ªçn ph·ª• t√πng </span>
                                </a>

                            </div>
                            <div>
                                <div class="flex items-center justify-end font-semibold gap-3">
                                    {% with record|calculate_total_payment_state as state %}
                                        <span class="text-blue-600">T·ªïng {{ state.total_purchase_amount|format_money }} VN√ê</span>
                                        <span class="text-green-600"> Thanh to√°n {{ state.total_transferred_amount|format_money }} VN√ê</span>
                                        <span class="text-red-600"> N·ª£ {{ state.total_debt_amount|format_money }} VN√ê</span>
                                    {% endwith %}
                                </div>
                            </div>
                        </div>
                        <div class="form-input flex flex-col h-fit h-max-[300px] gap-4 pt-4 pb-6 overflow-y-scroll">
                            <div class="border-b pb-0.5 flex w-full font-semibold">
                                <span class="w-5/12"> B·ªô ph·∫≠n </span>
                                <span class="w-1/12 text-center"> S·ªë l∆∞·ª£ng </span>
                                <span class="w-2/12 text-center"> Nh·∫≠n h√†ng </span>
                                <span class="w-2/12 text-center"> S·ª≠a ch·ªØa </span>
                                <span class="w-2/12 text-center"> Ng√†y th√™m </span>
                            </div> 
                            <div id="vehicle_parts">
                            {% for provider, vehice_parts in record.get_vehicle_part_list.items %}
                                {% with record.calculate_all_provider_payment_states|get_value:provider.pk as payment_state %}
                                    <div class="font-bold border-b pt-3 pb-1">
                                        {{ provider }} - 
                                        <span class="text-blue-600">T·ªïng {{ payment_state.purchase_amount|format_money }} VN√ê</span>
                                        <span class="text-green-600"> - Thanh to√°n {{ payment_state.transferred_amount|format_money }} VN√ê</span>
                                        <span class="text-red-600"> - N·ª£ {{ payment_state.debt_amount|format_money }} VN√ê</span>
                                    </div>
                                {% endwith %}
                                {% for vehice_part in vehice_parts %}
                                <div  class="vehice_part border-b py-2 flex items-center w-full" data-part-id="{{ vehice_part.repair_part.pk }}" data-part-quantity="{{ vehice_part.quantity }}">
                                    {% if record %}
                                    <input type="hidden" name="part_id" value="{{ vehice_part.repair_part.pk }}">
                                    <input type="hidden" name="vehicle_part_id" value="{{ vehice_part.pk }}">
                                    <input type="hidden" name="part_quantity_{{ vehice_part.repair_part.pk }}" value="{{ vehice_part.quantity }}">
                                    {% endif %}
                                    <span class="w-5/12"> {{ vehice_part.repair_part.part_number }} - {{ vehice_part.repair_part.part_name }} - {{ vehice_part.repair_part.part_price|format_money }} VNƒê </span>
                                    <span class="w-1/12 text-center"> {{ vehice_part.quantity }} </span>
                                    <div class="w-2/12 flex justify-center">
                                        <span class="{{ vehice_part|get_value:'received_status' }} text-white text-xs p-1 rounded-md shadow-2xl px-2 text-nowrap approve-hidable">{{ vehice_part|format_display:'received_status' }}</span>
                                        {% if record.approval_status == "approved" %}
                                            <select name="received_status_{{ vehice_part.pk }}" class="form-input hidable approve-hidable hidden" id="id_received_status" style="width: 150px">
                                                {% if vehice_part.received_status == "received" %}
                                                <option selected value="received">ƒê√£ nh·∫≠n</option>
                                                <option value="not_received">Ch∆∞a nh·∫≠n</option>
                                                {% else %}
                                                <option value="received">ƒê√£ nh·∫≠n</option>
                                                <option selected value="not_received">Ch∆∞a nh·∫≠n</option>
                                                {% endif %}
                                            </select>
                                        {% endif %}
                                    </div>


                                    <div class="w-2/12 flex justify-center">
                                        <span class="{{ vehice_part|get_value:'done_status' }} text-white text-xs p-1 rounded-md shadow-2xl px-2 text-nowrap approve-hidable">{{ vehice_part|format_display:'done_status' }}</span>
                                        {% if record.approval_status == "approved" %}
                                        <select name="done_status_{{ vehice_part.pk }}" class="form-input hidable approve-hidable hidden" id="id_done_status" style="width: 150px">
                                            {% if vehice_part.done_status == "done" %}
                                                <option selected value="done">Xong</option>
                                                <option value="not_done">Ch∆∞a xong</option>
                                            {% else %}
                                                <option value="done">Xong</option>
                                                <option selected value="not_done">Ch∆∞a xong</option>
                                            {% endif %}
                                        </select>
                                    {% endif %}
                                    </div>

                                    <div class="w-2/12 flex justify-center">
                                        {{ record.last_saved|date:"d/m/Y" }}
                                    </div>

                                </div>
                                {% endfor %}   
                            {% endfor %}    
                            </div>
                            

                        </div>
                    </div>


                {% elif modal == 'modal_PaymentRecord' %}
                <div class="flex items-center justify-center">
                <div class="flex pt-4 px-6 sm:w-[600px] gap-5 items-center justify-center">
                    <div class="modal-image1 modal-image-container w-auto flex items-center justify-center">
                        {% if record.image1 %}
                        <a href="{{ record.image1.url }}" target="_blank">
                            <img src="{{ record.image1.url }}" alt="student avatar"
                                class="mx-auto rounded-xl border border-slate-300 dark:border-slate-600">
                        </a>
                        {% else %}
                        <img src="/static/images/default/default_transaction.webp" alt="no image"
                            class="mx-auto rounded-xl border border-slate-300 dark:border-slate-600">
                        {% endif %}
                    </div>
                    <div class="modal-image2 modal-image-container w-auto flex items-center justify-center">
                        {% if record.image2 %}
                        <a href="{{ record.image2.url }}" target="_blank">
                            <img src="{{ record.image2.url }}" alt="student portrait"
                                class="mx-auto  rounded-xl border border-slate-300 dark:border-slate-600">
                        </a>
                        {% else %}
                        <img src="/static/images/default/default_transaction.webp" alt="no image"
                            class="mx-auto  rounded-xl border border-slate-300 dark:border-slate-600">
                        {% endif %}
                    </div>
                </div>
                </div>



                {% elif modal == "modal_SupplyOrder" %}
            
                    <div class="w-full pt-4 px-6 pt-5- pb-2">
                        <div class="flex flex-row gap-5 items-end py-2">
                            <label for="students" class="text-theme">Tr·∫°ng th√°i phi·∫øu mua v·∫≠t t∆∞</label>
                        </div>
                        <div class="form-input flex flex-col h-fit h-max-[300px] overflow-y-scroll">
                            <div class="flex justify-between w-full font-semibold">
                                <span class="w-3/12 text-center"> Tr·∫°ng th√°i duy·ªát </span>
                                <span class="w-3/12 text-center"> Tr·∫°ng th√°i nh·∫≠n h√†ng </span>
                                <span class="w-3/12 text-center"> Tr·∫°ng th√°i thanh to√°n </span>
                                <span class="w-3/12 text-center"> Tr·∫°ng th√°i s·ª≠a ch·ªØa </span>
                            </div> 
                            <div class="pt-3 pb-1 flex justify-between items-center w-full">
                                <div class="w-4/12 flex justify-center">
                                    {% if record %}
                                        <span class="{{ record|get_value:'approval_status' }} text-white p-1 rounded-md shadow-2xl px-2 text-nowrap hidable approve-hidable">{{ record|format_display:'approval_status' }}</span>
                            
                                        {% if not permissions.approve %}
                                        <select name="approval_status" class="form-input hidable approve-hidable hidden" id="id_approval_status" style="width: 150px">
                                            {% if record.approval_status == "scratch" %}
                                                <option selected value="scratch">B·∫£ng nh√°p</option>
                                                <option value="wait_for_approval">ChoÃõÃÄ duy·ªát</option>
                                                
                                            {% elif record.approval_status == "wait_for_approval" %}
                                                <option selected value="wait_for_approval">ChoÃõÃÄ duy·ªát</option>
                                                
                                            {% elif record.approval_status == "approved" %}
                                                <option selected value="approved">ƒêaÃÉ duyeÃ£ÃÇt</option>

                                            {% elif record.approval_status == "need_update" %}
                                                <option value="wait_for_approval">ChoÃõÃÄ duy·ªát</option>
                                                <option selected value="need_update">C·∫ßn s·ª≠a l·∫°i</option>

                                            {% elif record.approval_status == "rejected" %}
                                                <option value="rejected">TuÃõÃÄ choÃÇÃÅi</option>
                                            {% endif %}
                                        </select>
                                        {% else %}
                                        <select name="approval_status" class="form-input hidable approve-hidable hidden" id="id_approval_status" style="width: 150px">
                                            {% if record.approval_status == "scratch" %}
                                                <option selected value="scratch">B·∫£ng nh√°p</option>
                                                <option value="wait_for_approval">ChoÃõÃÄ duy·ªát</option>

                                            {% elif record.approval_status == "wait_for_approval" %}
                                                <option selected value="wait_for_approval">ChoÃõÃÄ duy·ªát</option>
                                                <option value="approved">ƒêaÃÉ duyeÃ£ÃÇt</option>
                                                <option value="need_update">C·∫ßn s·ª≠a l·∫°i</option>
                                                <option value="rejected">TuÃõÃÄ choÃÇÃÅi</option>

                                            {% elif record.approval_status == "approved" %}
                                                <option selected value="approved">ƒêaÃÉ duyeÃ£ÃÇt</option>
                                                <option value="need_update">C·∫ßn s·ª≠a l·∫°i</option>

                                            {% elif record.approval_status == "need_update" %}
                                                <option value="wait_for_approval">ChoÃõÃÄ duy·ªát</option>
                                                <option selected value="need_update">C·∫ßn s·ª≠a l·∫°i</option>

                                            {% elif record.approval_status == "rejected" %}
                                                <option value="need_update">C·∫ßn s·ª≠a l·∫°i</option>
                                                <option selected value="rejected">TuÃõÃÄ choÃÇÃÅi</option>
                                            {% endif %}
                                        
                                        </select>
                                        {% endif %}
                                        {% else %}
                                            <select name="approval_status" class="form-input hidable approve-hidable hidden" id="id_approval_status" style="width: 150px">
                                                
                                                <option selected value="scratch">B·∫£ng nh√°p</option>
                                            </select>
                                                <!-- <span class="scratch text-white p-1 rounded-md shadow-2xl px-2 text-nowrap hidable approve-hidable">B·∫£n nh√°p</span> -->
                                        {% endif %}
                                </div>
                                {% if record %}
                                <div class="w-4/12 text-center">
                                    <span class="{{ record|get_value:'received_status' }} text-white p-1 rounded-md shadow-2xl px-2 text-nowrap">{{ record|format_display:'received_status' }}</span>
                                </div>
                                <div class="w-4/12 text-center">
                                    <span class="{{ record|get_value:'paid_status' }} text-white p-1 rounded-md shadow-2xl px-2 text-nowrap">{{ record|format_display:'paid_status' }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>


                    <div class="w-full pt-4 px-6">
                        <p class="text-center text-theme"> L∆∞u √Ω: c√°c s·ªë li·ªáu t√†i ch√≠nh ch·ªâ ƒë∆∞·ª£c t√≠nh to√°n sau khi b·∫•m c·∫≠p nh·∫≠t </p>
                        <div class="flex flex-row justify-between gap-5 items-center py-1">
                            <div class="flex flex-row gap-5 items-end py-2">
                                <label for="students" class="text-theme">B·∫£ng v·∫≠t t∆∞ ƒë√£ ch·ªçn</label>
                                <!-- <button class="btn btn-success h-7 hidable hidden" onclick="event.preventDefault(); var newPart = document.querySelector('.new-part').cloneNode(true); newPart.classList.remove('hidden'); newPart.classList.remove('new-part'); newPart.querySelectorAll('input').forEach(input => input.value = ''); document.querySelector('.new-part').parentNode.insertBefore(newPart, document.querySelector('.new-part').nextSibling);">
                                    <i class="fas fa-plus me-3" style="font-size: 16px;"></i>
                                    Th√™m v√†o danh m·ª•c
                                </button> -->

                                <a href="{% url 'form_detailed_supplies' %}?project={{ project_id }}" class="btn btn-success h-7 hidable hidden"
                                    up-preload="insert" up-target="#modal-sub:maybe">
                                    <span class="me-3"> Ch·ªçn v·∫≠t t∆∞ </span>
                                </a>

                            </div>
                            <div>
                                <div class="flex items-center justify-end font-semibold gap-3">
                                    {% with record|calculate_total_payment_state as state %}
                                        <span class="text-blue-600">T·ªïng {{ state.total_purchase_amount|format_money }} VN√ê</span>
                                        <span class="text-green-600"> Thanh to√°n {{ state.total_transferred_amount|format_money }} VN√ê</span>
                                        <span class="text-red-600"> N·ª£ {{ state.total_debt_amount|format_money }} VN√ê</span>
                                    {% endwith %}
                                </div>
                            </div>
                        </div>
                        <div class="form-input flex flex-col h-fit h-max-[300px] gap-4 pt-4 pb-6 overflow-y-scroll">
                            <div class="border-b pb-0.5 flex w-full font-semibold">
                                <span class="w-5/12"> V·∫≠t t∆∞ </span>
                                <span class="w-1/12 text-center"> S·ªë l∆∞·ª£ng </span>
                                <span class="w-2/12 text-center"> Nh·∫≠n h√†ng </span>
                                <span class="w-2/12 text-center"> S·ª≠a ch·ªØa </span>
                                <span class="w-2/12 text-center"> Ng√†y th√™m </span>
                            </div> 
                            <div id="vehicle_parts">
                            {% for provider, vehice_parts in record.get_vehicle_part_list.items %}
                                {% with record.calculate_all_provider_payment_states|get_value:provider.pk as payment_state %}
                                    <div class="font-bold border-b pt-3 pb-1">
                                        {{ provider }} - 
                                        <span class="text-blue-600">T·ªïng {{ payment_state.purchase_amount|format_money }} VN√ê</span>
                                        <span class="text-green-600"> - Thanh to√°n {{ payment_state.transferred_amount|format_money }} VN√ê</span>
                                        <span class="text-red-600"> - N·ª£ {{ payment_state.debt_amount|format_money }} VN√ê</span>
                                    </div>
                                {% endwith %}
                                {% for vehice_part in vehice_parts %}
                                <div  class="vehice_part border-b py-2 flex items-center w-full" data-part-id="{{ vehice_part.repair_part.pk }}" data-part-quantity="{{ vehice_part.quantity }}">
                                    {% if record %}
                                    <input type="hidden" name="part_id" value="{{ vehice_part.repair_part.pk }}">
                                    <input type="hidden" name="vehicle_part_id" value="{{ vehice_part.pk }}">
                                    <input type="hidden" name="part_quantity_{{ vehice_part.repair_part.pk }}" value="{{ vehice_part.quantity }}">
                                    {% endif %}
                                    <span class="w-5/12"> {{ vehice_part.repair_part.part_number }} - {{ vehice_part.repair_part.part_name }} - {{ vehice_part.repair_part.part_price|format_money }} VNƒê </span>
                                    <span class="w-1/12 text-center"> {{ vehice_part.quantity }} </span>
                                    <div class="w-2/12 flex justify-center">
                                        <span class="{{ vehice_part|get_value:'received_status' }} text-white text-xs p-1 rounded-md shadow-2xl px-2 text-nowrap approve-hidable">{{ vehice_part|format_display:'received_status' }}</span>
                                        {% if record.approval_status == "approved" %}
                                            <select name="received_status_{{ vehice_part.pk }}" class="form-input hidable approve-hidable hidden" id="id_received_status" style="width: 150px">
                                                {% if vehice_part.received_status == "received" %}
                                                <option selected value="received">ƒê√£ nh·∫≠n</option>
                                                <option value="not_received">Ch∆∞a nh·∫≠n</option>
                                                {% else %}
                                                <option value="received">ƒê√£ nh·∫≠n</option>
                                                <option selected value="not_received">Ch∆∞a nh·∫≠n</option>
                                                {% endif %}
                                            </select>
                                        {% endif %}
                                    </div>


                                    <div class="w-2/12 flex justify-center">
                                        <span class="{{ vehice_part|get_value:'done_status' }} text-white text-xs p-1 rounded-md shadow-2xl px-2 text-nowrap approve-hidable">{{ vehice_part|format_display:'done_status' }}</span>
                                        {% if record.approval_status == "approved" %}
                                        <select name="done_status_{{ vehice_part.pk }}" class="form-input hidable approve-hidable hidden" id="id_done_status" style="width: 150px">
                                            {% if vehice_part.done_status == "done" %}
                                                <option selected value="done">Xong</option>
                                                <option value="not_done">Ch∆∞a xong</option>
                                            {% else %}
                                                <option value="done">Xong</option>
                                                <option selected value="not_done">Ch∆∞a xong</option>
                                            {% endif %}
                                        </select>
                                    {% endif %}
                                    </div>

                                    <div class="w-2/12 flex justify-center">
                                        {{ record.last_saved|date:"d/m/Y" }}
                                    </div>

                                </div>
                                {% endfor %}   
                            {% endfor %}    
                            </div>
                            

                        </div>
                    </div>

                {% elif modal == 'modal_PaymentRecord' %}
                <div class="flex items-center justify-center">
                <div class="flex pt-4 px-6 sm:w-[600px] gap-5 items-center justify-center">
                    <div class="modal-image1 modal-image-container w-auto flex items-center justify-center">
                        {% if record.image1 %}
                        <a href="{{ record.image1.url }}" target="_blank">
                            <img src="{{ record.image1.url }}" alt="student avatar"
                                class="mx-auto rounded-xl border border-slate-300 dark:border-slate-600">
                        </a>
                        {% else %}
                        <img src="/static/images/default/default_transaction.webp" alt="no image"
                            class="mx-auto rounded-xl border border-slate-300 dark:border-slate-600">
                        {% endif %}
                    </div>
                    <div class="modal-image2 modal-image-container w-auto flex items-center justify-center">
                        {% if record.image2 %}
                        <a href="{{ record.image2.url }}" target="_blank">
                            <img src="{{ record.image2.url }}" alt="student portrait"
                                class="mx-auto  rounded-xl border border-slate-300 dark:border-slate-600">
                        </a>
                        {% else %}
                        <img src="/static/images/default/default_transaction.webp" alt="no image"
                            class="mx-auto  rounded-xl border border-slate-300 dark:border-slate-600">
                        {% endif %}
                    </div>
                </div>
                </div>




                {%  endif %}










                <div class="flex justify-center items-center gap-16 pt-8 px-6 hidable approve-hidable
                {% if modal == "modal_VehicleMaintenance" %} hidden {% endif %}
                {% if record.lock %} hidden {% endif %}">
                    {% if record and record.archived == False %}
                        <button type="button" class="btn btn-danger rounded-full w-28 "
                            onclick="if (confirm('B·∫°n c√≥ th·ª±c s·ª± mu·ªën b·ªè d·ªØ li·ªáu n√†y v√†o th√πng r√°c kh√¥ng?\n\nL∆∞u √Ω: d·ªØ li·ªáu s·∫Ω kh√¥ng b·ªã x√≥a ho√†n to√†n, b·∫°n c√≥ th·ªÉ xem l·∫°i trong m·ª•c Th√πng r√°c.')) { 
                                document.getElementById('archived').value='true';
                                document.getElementById('submit-form').click();}">
                            X√≥a
                            <input name="archived" id="archived" class="hidden">
                        </button>
                    {% elif record and record.archived == True %}
                        <button type="button" class="btn btn-success rounded-full w-28 "
                            onclick="if (confirm('X√°c nh·∫≠n kh√¥i ph·ª•c d·ªØ li·ªáu?')) { 
                                document.getElementById('archived').value='false';
                                document.getElementById('submit-form').click();}">
                            Kh√¥i ph·ª•c
                            <input name="archived" id="archived" class="hidden">
                        </button>
                    {% endif %}

                    <div class="flex justify-center gap-3">
                        <button type="submit" id="submit-form" class="submit btn btn-primary rounded-full w-28">
                            {{ submit_button_name }}
                        </button>
                        <button id='cancel-modal' type="button" class="btn btn-secondary rounded-full w-28" onclick="document.getElementById('modal-body').remove();">
                            H·ªßy b·ªè
                        </button>
                    </div>
                </div>


            </form>
        </div>
    </div>
    {% if modal == 'modal_PaymentRecord' %}
    <script>
        // find label with f="requested_amount" and for="transfer"
        document.querySelectorAll('label[for]').forEach(el => {
            if (el.getAttribute('for') == 'requested_amount' 
                    || el.getAttribute('for') == 'transferred_amount'
                    || el.getAttribute('for') == 'money_source'
                    || el.getAttribute('for') == 'note') 
                    {
                el.classList.remove('text-theme');
                el.classList.add('text-green-600');
                el.classList.add('font-bold');
            }
        })
    </script>
    {% endif %}
</div>
