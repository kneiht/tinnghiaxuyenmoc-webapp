{% load custom_tags %}
{% load humanize %}
{% load static %}

<!-- Cards -->
{% if model == 'Project' %}
    {% include 'components/record_displays/projects.html' %}

{% elif model == 'Job' %}
    {% include 'components/record_displays/jobs.html' %}

{% elif model == 'Permission' %}
    {% include 'components/record_displays/permissions.html' %}

{% elif model == 'VehicleOperationRecord' %}
    {% include 'components/record_displays/vehicle_operations.html' %}

{% else %}
    {% include 'components/record_displays/general.html' %}

{% endif %}

{% if not update  %}
<div up-hungry id="load-more" class="flex justify-center items-center gap-4 my-4 pagination-container {% if current_page == 1 %} opacity-0 {% endif %}">
    {% if max_page >= 2 %}
    {% if current_page > 1 %}
        <a class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" 
           up-target="#display-records, #load-more:maybe"
           href="{% url 'load_elements' %}?q={% encode_params page=page model=model start_date=start_date end_date=end_date check_date=check_date check_month=check_month group_by=group_by tab=tab elements='display_records' current_page=1 project_id=project_id %}{% for field, value in search_queries.items %}&{{ field }}={{ value }}{% endfor %}&sort={{sort}}">
            1
        </a>
    {% endif %}
    
    {% if current_page > 3 %}
        <span class="text-gray-500">...</span>
    {% endif %}
    
    {% if current_page > 2 %}
        <a class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" 
           up-target="#display-records, #load-more:maybe"
           href="{% url 'load_elements' %}?q={% encode_params page=page model=model start_date=start_date end_date=end_date check_date=check_date check_month=check_month group_by=group_by tab=tab elements='display_records' current_page=current_page|add:"-1" project_id=project_id %}{% for field, value in search_queries.items %}&{{ field }}={{ value }}{% endfor %}&sort={{sort}}">
            {{ current_page|add:"-1" }}
        </a>
    {% endif %}
    
    <span class="px-4 py-2 bg-green-500 text-white rounded-md">{{ current_page }}</span>
    
    {% if current_page < max_page %}
        <a class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" 
           up-target="#display-records, #load-more:maybe"
           href="{% url 'load_elements' %}?q={% encode_params page=page model=model start_date=start_date end_date=end_date check_date=check_date check_month=check_month group_by=group_by tab=tab elements='display_records' current_page=current_page|add:"1" project_id=project_id %}{% for field, value in search_queries.items %}&{{ field }}={{ value }}{% endfor %}&sort={{sort}}">
            {{ current_page|add:"1" }}
        </a>
        
        {% if max_page and current_page < max_page|add:"-1" %}
            <span class="text-gray-500">...</span>
            <a class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" 
               up-target="#display-records, #load-more:maybe"
               href="{% url 'load_elements' %}?q={% encode_params page=page model=model start_date=start_date end_date=end_date check_date=check_date check_month=check_month group_by=group_by tab=tab elements='display_records' current_page=max_page project_id=project_id %}{% for field, value in search_queries.items %}&{{ field }}={{ value }}{% endfor %}&sort={{sort}}">
                {{ max_page }}
            </a>
        {% endif %}
    {% endif %}

    {% else %}
    <div></div>
    {% endif %}
    <script>

        function renderSearchQueries() {
            const searchQueriesDiv = document.getElementById('search-queries');
            if (!searchQueriesDiv) return;
            
            const searchQueries = {
                {% for key, value in search_queries.items %}
                    "{{ key }}": {
                        value: "{{ value }}",
                        verbose: "{{ key }}" === "all" ? "Tất cả" : "{{ model|get_verbose_name:key }}"
                    },
                {% endfor %}
            };
            
            // Check if there are any search queries
            const hasQueries = Object.entries(searchQueries).some(([_, data]) => data.value);
            
            if (!hasQueries) {
                searchQueriesDiv.classList.add('hidden');
                return;
            }
            
            searchQueriesDiv.classList.remove('hidden');
            searchQueriesDiv.innerHTML = '';
            
            for (const [key, data] of Object.entries(searchQueries)) {
                if (data.value) {
                    const tagHtml = `
                        <div class="filter-tag bg-blue-100 text-blue-800 px-3 rounded-md flex items-center gap-2 text-sm text-nowrap h-full border border-blue-300">
                            <span>${data.verbose}: ${data.value}</span>
                            
                            <button onclick="removeFilter('${key}')" class="text-blue-600 hover:text-blue-800">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    `;
                    searchQueriesDiv.innerHTML += tagHtml;
                }
            }
        }
        
        // Call when page loads
        renderSearchQueries();
        // If requested amount > 0, display it
        if ({{ requested_amount|default:0 }} > 0) {
            const checkExtraInfo = () => {
                const extraInfo = document.getElementById('extra-info');
                if (extraInfo) {
                    extraInfo.classList.remove('hidden');
                    totalRequestedAmountDisplay({{ requested_amount|default:0 }}); 
                } else {
                    setTimeout(checkExtraInfo, 100);
                }
            };
            checkExtraInfo();
        }
    </script>
</div>
{% endif %}
