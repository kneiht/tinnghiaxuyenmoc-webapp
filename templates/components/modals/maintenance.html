{% load custom_tags %}
                    <div class="w-full pt-4 px-6 pt-5- pb-2">
                        <div class="flex flex-row gap-5 items-end py-2">
                            <label for="students" class="text-theme">Trạng thái phiếu sửa chữa</label>
                        </div>
                        <div class="form-input flex flex-col h-fit h-max-[300px] overflow-y-scroll">
                            <div class="flex justify-between w-full font-semibold">
                                <span class="w-3/12 text-center"> Trạng thái duyệt </span>
                                <span class="w-3/12 text-center"> Trạng thái nhận hàng </span>
                                <span class="w-3/12 text-center"> Trạng thái thanh toán </span>
                                <span class="w-3/12 text-center"> Trạng thái sửa chữa </span>
                            </div> 
                            <div class="pt-3 pb-1 flex justify-between items-center w-full">
                                <div class="w-3/12 flex justify-center">
                                    {% if record %}
                                        <span class="{{ record|get_value:'approval_status' }} text-white p-1 rounded-md shadow-2xl px-2 text-nowrap hidable approve-hidable">{{ record|format_display:'approval_status' }}</span>
                            
                                        {% if not permissions.approve %}
                                        <select name="approval_status" class="form-input hidable approve-hidable hidden" id="id_approval_status" style="width: 150px">
                                            {% if record.approval_status == "scratch" %}
                                                <option selected value="scratch">Bảng nháp</option>
                                                <option value="wait_for_approval">Chờ duyệt</option>
                                                
                                            {% elif record.approval_status == "wait_for_approval" %}
                                                <option selected value="wait_for_approval">Chờ duyệt</option>
                                                
                                            {% elif record.approval_status == "approved" %}
                                                <option selected value="approved">Đã duyệt</option>

                                            {% elif record.approval_status == "rejected" %}
                                                <option value="rejected">Từ chối</option>
                                            {% endif %}
                                        </select>
                                        {% else %}
                                        <select name="approval_status" class="form-input hidable approve-hidable hidden" id="id_approval_status" style="width: 150px">
                                            {% if record.approval_status == "scratch" %}
                                                <option selected value="scratch">Bảng nháp</option>
                                                <option value="wait_for_approval">Chờ duyệt</option>

                                            {% elif record.approval_status == "wait_for_approval" %}
                                                <option selected value="wait_for_approval">Chờ duyệt</option>
                                                <option value="approved">Đã duyệt</option>
                                                <option value="rejected">Từ chối</option>

                                            {% elif record.approval_status == "approved" %}
                                                <option selected value="approved">Đã duyệt</option>

                                            {% elif record.approval_status == "rejected" %}
                                                <option selected value="rejected">Từ chối</option>
                                            {% endif %}
                                        
                                        </select>
                                        {% endif %}
                                        {% else %}
                                            <select name="approval_status" class="form-input hidable approve-hidable hidden" id="id_approval_status" style="width: 150px">
                                                
                                                <option selected value="scratch">Bảng nháp</option>
                                            </select>
                                                <span class="scratch text-white p-1 rounded-md shadow-2xl px-2 text-nowrap hidable approve-hidable">Bản nháp</span>
                                        {% endif %}
                                </div>
                                {% if record %}
                                <div class="w-3/12 text-center">
                                    <span class="{{ record|get_value:'received_status' }} text-white p-1 rounded-md shadow-2xl px-2 text-nowrap">{{ record|format_display:'received_status' }}</span>
                                </div>
                                <div class="w-3/12 text-center">
                                    <span class="{{ record|get_value:'paid_status' }} text-white p-1 rounded-md shadow-2xl px-2 text-nowrap">{{ record|format_display:'paid_status' }}</span>
                                </div>
                                <div class="w-3/12 text-center">
                                    <span class="{{ record|get_value:'done_status' }} text-white p-1 rounded-md shadow-2xl px-2 text-nowrap">{{ record|format_display:'done_status' }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>


                    <div class="w-full pt-4 px-6">
                        <p class="text-center text-theme"> Lưu ý: các số liệu tài chính chỉ được tính toán sau khi bấm cập nhật </p>
                        <div class="flex flex-row justify-between gap-5 items-center py-1">
                            <div class="flex flex-row gap-5 items-end py-2">
                                <label for="students" class="text-theme">Các bộ phận thay thế</label>
                                <!-- <button class="btn btn-success h-7 hidable hidden" onclick="event.preventDefault(); var newPart = document.querySelector('.new-part').cloneNode(true); newPart.classList.remove('hidden'); newPart.classList.remove('new-part'); newPart.querySelectorAll('input').forEach(input => input.value = ''); document.querySelector('.new-part').parentNode.insertBefore(newPart, document.querySelector('.new-part').nextSibling);">
                                    <i class="fas fa-plus me-3" style="font-size: 16px;"></i>
                                    Thêm vào danh mục
                                </button> -->

                                <a href="{% url 'form_repair_parts' %}?maintenance={{ record.pk }}" class="btn btn-success h-7 hidable hidden"
                                    up-preload="insert" up-target="#modal-sub:maybe">
                                    <span class="me-3"> Chọn phụ tùng </span>
                                </a>

                            </div>
                            <div>
                                <div class="flex items-center justify-end font-semibold gap-3">
                                    {% with record|calculate_total_payment_state as state %}
                                        <span class="text-blue-600">Tổng {{ state.total_purchase_amount|format_money }} VNÐ</span>
                                        <span class="text-green-600"> Thanh toán {{ state.total_transferred_amount|format_money }} VNÐ</span>
                                        <span class="text-red-600"> Nợ {{ state.total_debt_amount|format_money }} VNÐ</span>
                                    {% endwith %}
                                </div>
                            </div>
                        </div>
                        <div class="form-input flex flex-col h-fit h-max-[300px] gap-4 pt-4 pb-6 overflow-y-scroll">
                            <div class="border-b pb-0.5 flex w-full font-semibold">
                                <span class="w-5/12"> Bộ phận </span>
                                <span class="w-1/12 text-center"> Số lượng </span>
                                <span class="w-2/12 text-center"> Nhận hàng </span>
                                <span class="w-2/12 text-center"> Sửa chữa </span>
                                <span class="w-2/12 text-center"> Ngày thêm </span>
                            </div> 
                            <div id="vehicle_parts">
                            {% for provider, vehice_parts in record.get_vehicle_part_list.items %}
                                {% with record.calculate_all_provider_payment_states|get_value:provider.pk as payment_state %}
                                    <div class="font-bold border-b pt-3 pb-1">
                                        {{ provider }} - 
                                        <span class="text-blue-600">Tổng {{ payment_state.purchase_amount|format_money }} VNÐ</span>
                                        <span class="text-green-600"> - Thanh toán {{ payment_state.transferred_amount|format_money }} VNÐ</span>
                                        <span class="text-red-600"> - Nợ {{ payment_state.debt_amount|format_money }} VNÐ</span>
                                    </div>
                                {% endwith %}
                                {% for vehice_part in vehice_parts %}
                                <div  class="vehice_part border-b py-2 flex items-center w-full" data-part-id="{{ vehice_part.repair_part.pk }}" data-part-quantity="{{ vehice_part.quantity }}">
                                    {% if record %}
                                    <input type="hidden" name="part_id" value="{{ vehice_part.repair_part.pk }}">
                                    <input type="hidden" name="vehicle_part_id" value="{{ vehice_part.pk }}">
                                    <input type="hidden" name="part_quantity_{{ vehice_part.repair_part.pk }}" value="{{ vehice_part.quantity }}">
                                    {% endif %}
                                    <span class="w-5/12"> {{ vehice_part.repair_part.part_number }} - {{ vehice_part.repair_part.part_name }} - {{ vehice_part.repair_part.part_price|format_money }} VNĐ </span>
                                    <span class="w-1/12 text-center"> {{ vehice_part.quantity }} </span>
                                    <div class="w-2/12 flex justify-center">
                                        <span class="{{ vehice_part|get_value:'received_status' }} text-white text-xs p-1 rounded-md shadow-2xl px-2 text-nowrap approve-hidable">{{ vehice_part|format_display:'received_status' }}</span>
                                        {% if record.approval_status == "approved" %}
                                            <select name="received_status_{{ vehice_part.pk }}" class="form-input hidable approve-hidable hidden" id="id_received_status" style="width: 150px">
                                                {% if vehice_part.received_status == "received" %}
                                                <option selected value="received">Đã nhận</option>
                                                <option value="not_received">Chưa nhận</option>
                                                {% else %}
                                                <option value="received">Đã nhận</option>
                                                <option selected value="not_received">Chưa nhận</option>
                                                {% endif %}
                                            </select>
                                        {% endif %}
                                    </div>


                                    <div class="w-2/12 flex justify-center">
                                        <span class="{{ vehice_part|get_value:'done_status' }} text-white text-xs p-1 rounded-md shadow-2xl px-2 text-nowrap approve-hidable">{{ vehice_part|format_display:'done_status' }}</span>
                                        {% if record.approval_status == "approved" %}
                                        <select name="done_status_{{ vehice_part.pk }}" class="form-input hidable approve-hidable hidden" id="id_done_status" style="width: 150px">
                                            {% if vehice_part.done_status == "done" %}
                                                <option selected value="done">Xong</option>
                                                <option value="not_done">Chưa xong</option>
                                            {% else %}
                                                <option value="done">Xong</option>
                                                <option selected value="not_done">Chưa xong</option>
                                            {% endif %}
                                        </select>
                                    {% endif %}
                                    </div>

                                    <div class="w-2/12 flex justify-center">
                                        {{ record.last_saved|date:"d/m/Y" }}
                                    </div>

                                </div>
                                {% endfor %}   
                            {% endfor %}    
                            </div>
                            

                        </div>
                    </div>
