{% load custom_tags %}
{% load humanize %}

<div id="display-records">
    <table id="weekplan-table"
        class="table-auto w-full overflow-hidden mt-4 border border-slate-300 dark:border-slate-900 border-opacity-50 rounded-2xl shadow-md">
        <thead>
            <tr class="text-md text-center leading-normal text-theme rounded-2xl shadow-md bg-white dark:bg-slate-700
            border border-slate-300 dark:border-slate-900 border-opacity-50">
                <th colspan="100" class="px-6 py-3 text-left font-semibold">
                    <div class="flex justify-between items-center">
                        <span>Kế hoạch tuần {{ week }}</span>

                        <div class="flex flex-wrap gap-4">

                            <a data-date="{{ monday }}" up-preload="insert" up-target="#display-records" href="{% url 'load_weekplan_table' project_id=project_id %}?check_date={{ monday }}" type="button" class="select-date btn btn-outline-no-focus
                            {% if check_date == monday %} bg-green-600 {% endif %}">
                                Thứ 2
                            </a>

                            <a data-date="{{ tuesday }}" up-preload="insert" up-target="#display-records" href="{% url 'load_weekplan_table' project_id=project_id %}?check_date={{ tuesday }}" type="button" class="select-date btn btn-outline-no-focus
                            {% if check_date == tuesday %} bg-green-600 {% endif %}">
                                Thứ 3
                            </a>

                            <a data-date="{{ wednesday }}" up-preload="insert" up-target="#display-records" href="{% url 'load_weekplan_table' project_id=project_id %}?check_date={{ wednesday }}" type="button" class="select-date btn btn-outline-no-focus
                            {% if check_date == wednesday %} bg-green-600 {% endif %}"
                                        onclick="document.getElementById('#check_date').value = '{{ wednesday }}'";>
                                Thứ 4
                            </a>

                            <a data-date="{{ thursday }}" up-preload="insert" up-target="#display-records" href="{% url 'load_weekplan_table' project_id=project_id %}?check_date={{ thursday }}" type="button" class="select-date btn btn-outline-no-focus
                            {% if check_date == thursday %} bg-green-600 {% endif %}">
                                Thứ 5
                            </a>   

                            <a data-date="{{ friday }}" up-preload="insert"  up-target="#display-records" href="{% url 'load_weekplan_table' project_id=project_id %}?check_date={{ friday }}" type="button" class="select-date btn btn-outline-no-focus
                            {% if check_date == friday %} bg-green-600 {% endif %}">
                                Thứ 6
                            </a>

                            <a data-date="{{ saturday }}" up-preload="insert" up-target="#display-records" href="{% url 'load_weekplan_table' project_id=project_id %}?check_date={{ saturday }}" type="button" class="select-date btn btn-outline-no-focus
                            {% if check_date == saturday %} bg-green-600 {% endif %}">
                                Thứ 7
                            </a>

                            <a data-date="{{ sunday }}" up-preload="insert" up-target="#display-records" href="{% url 'load_weekplan_table' project_id=project_id %}?check_date={{ sunday }}" type="button" class="select-date btn btn-outline-no-focus
                            {% if check_date == sunday %} bg-green-600 {% endif %}">
                                CN
                            </a>

                        </div>



                        <div class="flex gap-4">

                            <button class="btn btn-success" 
                                    onclick="
                                        document.getElementById('weekplan-table').classList.add('hidden'); 
                                        document.getElementById('date-report-form-table').classList.remove('hidden');">
                                Cập nhật báo cáo ngày {{check_date_format }}
                            </button>

                            <button class="btn btn-primary" 
                                    onclick="
                                        document.getElementById('weekplan-table').classList.add('hidden'); 
                                        document.getElementById('weekplan-form-table').classList.remove('hidden');">
                                Cập nhật kế hoạch tuần
                            </button>
                        </div>
                    </div>
                </th>
                
            </tr> 
        </thead>
        <thead>
                <tr class="text-sm leading-normal text-theme rounded-2xl shadow-md bg-white dark:bg-slate-800
                border border-slate-300 dark:border-slate-900 border-opacity-50">
                    
                        <th class="px-6 py-3 text-left font-semibold">Tên công việc</th>
                        <th class="px-6 py-3 text-left font-semibold">Loại công việc</th>
                        <th class="px-6 py-3 text-left font-semibold">Trạng thái</th>
                        <th class="px-6 py-3 text-left font-semibold">Đơn vị</th>
                        <th class="px-6 py-3 text-left font-semibold">Khối lượng kế hoạch tuần</th>
                        <th class="px-6 py-3 text-left font-semibold">Ghi chú tuần</th>

                        <th class="px-6 py-3 text-left font-semibold">Khối lượng ngày</th>
                        <th class="px-6 py-3 text-left font-semibold">Ghi chú ngày</th>

                        <th class="px-6 py-3 text-left font-semibold">Tiến độ</th>

                    
                    <th></th>
                </tr>
        </thead>
        {% for record in jobplans_in_week %}
        <tbody id="record_{{ record.pk }}">
            <tr
                class=" bg-gray-50 hover:bg-blue-100 dark:bg-gray-800 dark:even:bg-gray-700 dark:hover:bg-gray-600">

                <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                    {{ record.job.name }}
                </td>

                <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                    {{ record.job.category }}
                </td>
                <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                    <span class="{{ record.job.status }} text-white p-1 rounded-md shadow-2xl top-5 right-5 px-2 text-nowrap">{{ record.job.get_status_display }}</span>
                </td>

                <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                    {{ record.job.unit }}
                </td>

                <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                    {{ record.plan_quantity|intcomma }}
                </td>

                <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                    {{ record.note }}
                </td>


                <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                    {{ record.date_quantity|intcomma }}
                </td>
                <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                    {{ record.date_note }}
                </td>

                <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                    <div class="flex flex-col gap-2">
                        <div class="w-full bg-gray-300 rounded-full dark:bg-gray-700 text-nowrap">
                                <div class="bg-{{ record.progress_by_time.status }}-600 text-xs font-medium text-white  text-center p-0.5 leading-none rounded-full" style="width: {{ record.progress_by_time.percent }}%">
                                    {% if record.progress_by_time.status != 'gray' and record.progress_by_time.status != 'green' %}
                                        {{ record.progress_by_time.progress }} / {{ record.progress_by_time.duration }} ngày
                                    {% else %}
                                        {{ record.job.get_status_display }}
                                    {% endif %}
                                </div>

                        </div>

                        <div class="w-full bg-gray-300 rounded-full dark:bg-gray-700 text-nowrap">
                                <div class="bg-{{ record.progress_by_quantity.status }}-600 text-xs font-medium text-white  text-center p-0.5 leading-none rounded-full" style="width: {{ record.progress_by_quantity.percent }}%">
                                    {{ record.progress_by_quantity.total_quantity_reported|intcomma }} / {{ record.progress_by_quantity.total_quantity|intcomma }} khối lượng
                                </div>

                        </div>
                    </div>
                </td>





            </tr>
        </tbody>


        {% endfor %}
    </table>


    <form id="weekplan-form" action="{% url 'handle_weekplan_form' %}" method="POST" up-target="#display-records:maybe">
        {% csrf_token %}
        <input type="date" name="start_date" value="{{ monday }}" class="hidden">
        <input type="date" name="end_date" value="{{ sunday }}" class="hidden">
        <input type="date" name="check_date" value="{{ check_date }}" class="hidden">

        <input type="number" name="project_id" value="{{ project_id }}" class="hidden">
        <table id="weekplan-form-table"
            class="hidden table-auto w-full overflow-hidden mt-4 border border-slate-300 dark:border-slate-900 border-opacity-50 rounded-2xl shadow-md">
            <thead>
                <tr class="text-md text-center leading-normal text-theme rounded-2xl shadow-md bg-white dark:bg-slate-700
                border border-slate-300 dark:border-slate-900 border-opacity-50">
                    <th colspan="100" class="px-6 py-3 text-left font-semibold">
                        <div class="flex justify-between items-center">
                            <span>Cập nhật kế hoạch tuần {{ week }}</span>
                            <div class="flex gap-5">

                                <button type="submit" class="btn btn-success">Lưu kế hoạch</button>

                                <button type="button" class="btn btn-primary" 
                                        onclick="
                                            document.getElementById('weekplan-form-table').classList.add('hidden'); 
                                            document.getElementById('date-report-form-table').classList.add('hidden'); 
                                            document.getElementById('weekplan-table').classList.remove('hidden');">
                                    Xem kế hoạch
                                </button>


                            </div>
                        </div>
                    </th>
                    
                </tr> 
            </thead>
            <thead>
                <thead>
                    <tr class="text-sm leading-normal text-theme rounded-2xl shadow-md bg-white dark:bg-slate-800
                    border border-slate-300 dark:border-slate-900 border-opacity-50">
                        
                            <th class="px-6 py-3 text-left font-semibold">Tên công việc</th>
                        
                            <th class="px-6 py-3 text-left font-semibold">Loại công việc</th>
                        
                            <th class="px-6 py-3 text-left font-semibold">Trạng thái</th>
                    
                            <th class="px-6 py-3 text-left font-semibold">Khối lượng</th>
                        
                            <th class="px-6 py-3 text-left font-semibold">Bắt đầu</th>
                        
                            <th class="px-6 py-3 text-left font-semibold">Kết thúc</th>

                            <th class="px-6 py-3 text-left font-semibold">Khối lượng kế hoạch tuần</th>
                            <th class="px-6 py-3 text-left font-semibold">Ghi chú trong tuần</th>
                        
                        <th></th>
                    </tr>
        
                </thead>

            </thead>
            {% for record in jobs %}
            <tbody id="record_{{ record.pk }}">
                <tr
                    class=" bg-gray-50 hover:bg-blue-100 dark:bg-gray-800 dark:even:bg-gray-700 dark:hover:bg-gray-600">

                    <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                        {{ record.name }}
                    </td>

                    <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                        {{ record.category }}
                    </td>
                    <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                        {{ record.get_status_display }}
                    </td>

                    <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                        {{ record.quantity|intcomma }} ({{ record.unit }})
                    </td>


                    <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                        {{ record.start_date|date:"d/m/Y" }}
                    </td>
                    <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                        {{ record.end_date|date:"d/m/Y" }}
                    </td>
                    {% for jobplan in jobplans_in_week %}
                        {% if jobplan.job == record %}
                            <input type="number" name="jobplan_{{ record.pk }}" class="hidden form-input" value="{{ jobplan.pk }}" />
                        {% endif %}
                    {% endfor %}
                    <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm">

                        <input type="number" name="plan_quantity_{{ record.pk }}" class="form-input" value="{{ record.plan_quantity }}"/>
                    </td>
                    <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm">
                        <input type="text" name="note_{{ record.pk }}" class="form-input" 
                        value="{{ record.plan_note }}" />

                    </td>
                </tr>
            </tbody>
            {% endfor %}
        </table>
    </form>

    <form id="date-report-form" action="{% url 'handle_date_report_form' %}" method="POST" up-target="#display-records:maybe">
        {% csrf_token %}
        <input type="date" name="check_date" value="{{ check_date }}" class="hidden">

        <input type="number" name="project_id" value="{{ project_id }}" class="hidden">
        <table id="date-report-form-table"
            class="hidden table-auto w-full overflow-hidden mt-4 border border-slate-300 dark:border-slate-900 border-opacity-50 rounded-2xl shadow-md">
            <thead>
                <tr class="text-md text-center leading-normal text-theme rounded-2xl shadow-md bg-white dark:bg-slate-700
                border border-slate-300 dark:border-slate-900 border-opacity-50">
                    <th colspan="100" class="px-6 py-3 text-left font-semibold">
                        <div class="flex justify-between items-center">
                            <span>Cập nhật báo cáo ngày {{ check_date_format }}</span>
                            <div class="flex gap-5">

                                <button type="submit" class="btn btn-success">Lưu báo cáo ngày {{ check_date_format }}</button>

                                <button type="button" class="btn btn-primary" 
                                        onclick="
                                            document.getElementById('weekplan-form-table').classList.add('hidden'); 
                                            document.getElementById('date-report-form-table').classList.add('hidden'); 
                                            document.getElementById('weekplan-table').classList.remove('hidden');">
                                    Xem kế hoạch
                                </button>


                            </div>
                        </div>
                    </th>
                    
                </tr> 
            </thead>
            <thead>
                <thead>
                    <tr class="text-sm leading-normal text-theme rounded-2xl shadow-md bg-white dark:bg-slate-800
                    border border-slate-300 dark:border-slate-900 border-opacity-50">
                        
                            <th class="px-6 py-3 text-left font-semibold">Tên công việc</th>
                        
                            <th class="px-6 py-3 text-left font-semibold">Loại công việc</th>
                        
                            <th class="px-6 py-3 text-left font-semibold">Trạng thái</th>
                    
                            <th class="px-6 py-3 text-left font-semibold">Khối lượng</th>
                        
                            <th class="px-6 py-3 text-left font-semibold">Bắt đầu</th>
                        
                            <th class="px-6 py-3 text-left font-semibold">Kết thúc</th>

                            <th class="px-6 py-3 text-left font-semibold">Khối lượng hoàn thành</th>

                            <th class="px-6 py-3 text-left font-semibold">Ghi chú trong ngày</th>
                        
                        <th></th>
                    </tr>
        
                </thead>

            </thead>
            {% for record in jobplans_in_week %}
            <tbody id="record_{{ record.pk }}">
                <tr
                    class=" bg-gray-50 hover:bg-blue-100 dark:bg-gray-800 dark:even:bg-gray-700 dark:hover:bg-gray-600">

                    <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                        {{ record.job.name }}
                    </td>

                    <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                        {{ record.job.category }}
                    </td>
                    <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                        {{ record.job.get_status_display }}
                    </td>

                    <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                        {{ record.job.quantity|intcomma }} ({{ record.job.unit }})
                    </td>


                    <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                        {{ record.job.start_date|date:"d/m/Y" }}
                    </td>
                    <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                        {{ record.job.end_date|date:"d/m/Y" }}
                    </td>
                    {% for job_date_report in job_date_reports %}
                        {% if job_date_report.job == record.job %}
                            <input type="number" name="job_date_report_{{ record.job.pk }}" class="hidden form-input" value="{{ job_date_report.pk }}" />
                        {% endif %}
                    {% endfor %}
                    <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm">

                        <input type="number" name="date_quantity_{{ record.job.pk }}" class="form-input" value="{{ record.date_quantity }}"/>
                    </td>
                    <td class="px-6 py-3 border-b border-gray-200 dark:border-gray-600 text-sm">
                        <input type="text" name="date_note_{{ record.job.pk }}" class="form-input" 
                        value="{{ record.date_note }}" />

                    </td>
                </tr>
            </tbody>


            {% endfor %}
        </table>

    </form>


</div>


